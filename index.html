<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>合同号与数量匹配工具 - 修正版</title>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<style>
  body { font-family: "Microsoft YaHei", margin: 20px; }
  textarea { width: 48%; height: 150px; margin: 10px 1%; }
  table { border-collapse: collapse; margin-top: 20px; width: 100%; table-layout: fixed; }
  th, td { border: 1px solid #333; padding: 4px; text-align: center; cursor: default; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  th { background: #f0f0f0; cursor: pointer; }
  td.copyable { cursor: pointer; color: #007bff; }
  button { padding: 6px 12px; margin: 10px 5px 10px 0; }
  .stats span { margin-left: 15px; font-weight: bold; }
  .highlight { color: white; background-color: #007bff; padding: 2px 6px; border-radius: 3px; }
  .unmatched { background-color: #e97255; } /* 表一未匹配高亮 */
  .unmatched2 { background-color: #ffe0b2; } /* 表二未匹配高亮 */
  .matched-highlight { background-color: #90caf9 !important; } /* 点击表二高亮表一匹配行 */
  h3 { margin-top: 30px; }
</style>
</head>
<body>

<div id="app">
  <h2>合同号与数量匹配工具（修正版）</h2>
 <div style="display: flex; gap: 10px;">
  <textarea v-model="table1Text" placeholder="粘贴第一个表格（主表）" style="flex: 1; height: 150px;"></textarea>
  <textarea v-model="table2Text" placeholder="粘贴第二个表格（合同表）" style="flex: 1; height: 150px;"></textarea>
</div>
  <div class="stats">
    <button @click="updateMatch">手动匹配</button>
    <button @click="copyResult">复制结果</button>
    <span class="highlight">表1件数合计: {{ sumTable1Qty }}</span>
    <span class="highlight">表2总件数: {{ sumTable2Qty }}</span>
    <span class="highlight">已匹配数量合计: {{ sumMatchedQty }} </span>
    <span class="highlight">表2总重量: {{ sumTable2Weight }}</span>
    <span class="highlight">已匹配总重: {{ sumMatchedQty }}  *200 KG  =  {{ sumMatchedQty * 200 }} KG</span>
  </div>

  <!-- 表1结果 -->
<div v-if="result.length">
  <h3>表1匹配结果</h3>
  <div ref="table1Container" style="overflow:auto;">
    <table style="width: max-content;">
      <thead>
        <tr>
          <th v-for="(h, index) in result[0]" :key="index" @click="copyColumn(index)"
              style="direction: ltr; text-align: left;">
            {{ h }}
          </th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(row, rowIndex) in result.slice(1)" :key="rowIndex"
            :class="{'unmatched': row[row.length-1] === '未匹配', 'matched-highlight': highlightedRows.includes(rowIndex)}">
          <td v-for="(cell, colIndex) in row" 
              :key="colIndex"
              class="copyable"
              @click="copyCell(cell)"
              style="direction: ltr; text-align: left;">
            {{ cell }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


  <!-- 表2详细信息 -->
  <div v-if="table2Data.length">
    <h3>表2详细信息</h3>
    <table>
      <thead>
        <tr>
          <th v-for="(h, index) in table2Data[0]" :key="index">{{ h }}</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(row, rowIndex) in table2Data.slice(1)" :key="rowIndex"
            :class="{'unmatched2': row._unmatched}"
            @click="highlightTable1(row, rowIndex)">
          <td v-for="(cell, colIndex) in row" :key="colIndex" v-html="formatCell(row, colIndex, rowIndex)"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 表二等级统计 -->
  <div v-if="levelStats.length">
    <h3>表2等级统计</h3>
    <table>
      <thead>
        <tr>
          <th>等级</th>
          <th>总件数</th>
          <th>总重量</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="item in levelStats" :key="item.level">
          <td>{{ item.level }}</td>
          <td>{{ item.totalQty }}</td>
          <td>{{ item.totalWeight }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 合同号匹配统计 -->
  <div v-if="contractStats.length">
    <h3>合同号匹配统计</h3>
    <table>
      <thead>
        <tr>
          <th>合同号</th>
          <th>原始件数</th>
          <th>已匹配件数</th>
          <th>剩余件数</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="item in contractStats" :key="item.contract">
          <td>{{ item.contract }}</td>
          <td>{{ item.originalQty }}</td>
          <td>{{ item.matchedQty }}</td>
          <td>{{ item.remainingQty }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const { createApp, ref, computed, watch, nextTick } = Vue;

createApp({
  setup() {
    const table1Text = ref('');
    const table2Text = ref('');
    const result = ref([]);
    const table2Data = ref([]);
    const contractStats = ref([]);
    const levelStats = ref([]);
    const highlightedRows = ref([]);
    const table1Container = ref(null);

    // 新结构：entries 列表 + entriesByRow 映射
    let entries = []; // {id, key, level, qty, contract, rowIndex, used, matchedToRow1, weightPart}
    let entriesByRow = {}; // rowIndex -> [entryId, ...]

    function parseExcelText(text){
      return text.trim().split(/\r?\n/).map(line=>line.split(/\t/).map(cell=>cell.trim()));
    }

    function normalize(str){ return str ? String(str).trim().toUpperCase() : ''; }

    function parseLevelQty(levelStr){
      if(!levelStr) return [];
      return levelStr.split(',').map(p=>{
        const m=p.trim().match(/^(\S+)\s+(\d+(?:\.\d+)?)$/);
        return m? {level:normalize(m[1]), qty:parseFloat(m[2])} : null;
      }).filter(Boolean);
    }

    function findColumnIndex(header, name){ return header.indexOf(name); }

    const sumTable1Qty = computed(()=>{
      if(!result.value.length) return 0;
      const qtyIndex = findColumnIndex(result.value[0],'件数');
      if(qtyIndex===-1) return 0;
      return result.value.slice(1).reduce((s,row)=>s+(parseFloat(String(row[qtyIndex]||'0').replace(/,/g,''))||0),0);
    });

    const sumTable2Qty = computed(()=>{
      if(!table2Data.value.length) return 0;
      const idx = findColumnIndex(table2Data.value[0],'物料信息');
      if(idx===-1) return 0;
      return table2Data.value.slice(1).reduce((s,row)=>{
        parseLevelQty(row[idx]).forEach(l=>s+=l.qty);
        return s;
      },0);
    });

    const sumTable2Weight = computed(()=>{
      if(!table2Data.value.length) return 0;
      const idx = findColumnIndex(table2Data.value[0],'重量');
      if(idx===-1) return 0;
      return table2Data.value.slice(1).reduce((s,row)=>s+(parseFloat(row[idx]||0)||0),0);
    });

    const sumMatchedQty = computed(()=>{
      if(!result.value.length) return 0;
      const qtyIndex = findColumnIndex(result.value[0],'件数');
      const statusIndex = findColumnIndex(result.value[0],'件数(匹配状态)');
      if(qtyIndex===-1 || statusIndex===-1) return 0;
      return result.value.slice(1).reduce((s,row)=>s+((row[statusIndex]==='完全匹配')? (parseFloat(String(row[qtyIndex]||'0').replace(/,/g,''))||0) : 0),0);
    });

    
    function updateMatch(){
  highlightedRows.value=[];
  const data1 = parseExcelText(table1Text.value);
  const data2Raw = parseExcelText(table2Text.value);
  table2Data.value = data2Raw.map((row,i)=>i===0?row:row.slice());
  if(!data1.length || !data2Raw.length) {
    result.value = [];
    contractStats.value = [];
    levelStats.value = [];
    entries = []; entriesByRow = {};
    return;
  }

  const levelIdx1 = findColumnIndex(data1[0],'等级');
  const qtyIdx1 = findColumnIndex(data1[0],'件数');

  const header2 = data2Raw[0];
  const materialIdx = findColumnIndex(header2,'物料信息');
  const contractIdx = findColumnIndex(header2,'合同编号');
  const weightIdx = findColumnIndex(header2,'重量');

  // 重建 entries
  entries = [];
  entriesByRow = {};
  for(let i=1;i<data2Raw.length;i++){
    const levels = parseLevelQty(data2Raw[i][materialIdx]);
    const contract = data2Raw[i][contractIdx] || '';
    const weight = parseFloat(data2Raw[i][weightIdx]||0) || 0;
    const totalQty = levels.reduce((s,it)=>s+it.qty,0) || 0;

    entriesByRow[i] = entriesByRow[i] || [];

    levels.forEach(l=>{
      const key = `${l.level}_${l.qty}`;
      const id = entries.length;
      const weightPart = totalQty>0 ? (weight*(l.qty/totalQty)) : 0;
      entries.push({id,key,level:l.level,qty:l.qty,contract,rowIndex:i,used:false,weightPart});
      entriesByRow[i].push(id);
    });
  }

  // --- 第一轮匹配：全局唯一匹配 ---
  const newData = [data1[0].concat("合同编号(匹配)","件数(匹配状态)")];
  for(let i=1;i<data1.length;i++){
    const row = data1[i];
    const level = normalize(row[levelIdx1]);
    const qty = parseFloat(String(row[qtyIdx1]||'0').replace(/,/g,''))||0;
    const key = `${level}_${qty}`;

    // 找 entries 中唯一未用的匹配
    const candidates = entries.filter(e=>e.key===key && !e.used);
    if(candidates.length===1){
      const e = candidates[0];
      e.used = true;
      row.push(e.contract, "完全匹配");
    } else {
      row.push("未匹配", "未匹配"); // 第二轮处理
    }
    newData.push(row);
  }

 // --- 第二轮匹配：处理重复合同号，优先上下行 ---
const unmatchedRows = [];
for(let i=1;i<newData.length;i++){
  if(newData[i][newData[i].length-1]==="未匹配"){
    unmatchedRows.push(i);
  }
}

unmatchedRows.forEach(i=>{
  const row = newData[i];
  const level = normalize(row[levelIdx1]);
  const qty = parseFloat(String(row[qtyIdx1]||'0').replace(/,/g,''))||0;
  const key = `${level}_${qty}`;

  const prevContract = i>1 ? newData[i-1][newData[i-1].length-2] : null;
  const nextContract = i+1<newData.length ? newData[i+1][newData[i+1].length-2] : null;

  let idx = -1;
  if(prevContract && prevContract!=="未匹配"){
    idx = entries.findIndex(e=>e.key===key && !e.used && e.contract===prevContract);
  }
  if(idx===-1 && nextContract && nextContract!=="未匹配"){
    idx = entries.findIndex(e=>e.key===key && !e.used && e.contract===nextContract);
  }

  if(idx===-1){
    idx = entries.findIndex(e=>e.key===key && !e.used);
  }

  if(idx!==-1){
    const e = entries[idx];
    e.used = true; // 标记已匹配，不再参与任何匹配
    row[row.length-2] = e.contract;
    row[row.length-1] = "完全匹配";
  }
});


  // 标记表2未匹配子项
  table2Data.value.slice(1).forEach((row, idx)=>{
    const rowIndex = idx+1;
    const ids = entriesByRow[rowIndex] || [];
    row._unmatched = ids.some(id=>!entries[id].used);
  });

  result.value = newData;
}


    function highlightTable1(row, rowIndex){
      highlightedRows.value = [];
      // rowIndex here is 0-based relative to table2Data.slice(1), so map back:
      const realRowIndex = rowIndex + 1;
      const header2 = table2Data.value[0];
      const materialIdx = findColumnIndex(header2,'物料信息');
      const levels = parseLevelQty(row[materialIdx]);
      const levelIdx1 = findColumnIndex(result.value[0],'等级');
      const qtyIdx1 = findColumnIndex(result.value[0],'件数');

      result.value.slice(1).forEach((r,i)=>{
        levels.forEach(l=>{
          if(normalize(r[levelIdx1]) === l.level && (parseFloat(String(r[qtyIdx1]||'0').replace(/,/g,''))||0) === l.qty){
            highlightedRows.value.push(i);
          }
        });
      });

      nextTick(()=>{
        if(highlightedRows.value.length && table1Container.value){
          const tr = table1Container.value.querySelectorAll('tbody tr')[highlightedRows.value[0]];
          if(tr) tr.scrollIntoView({behavior:'smooth',block:'center'});
        }
      });
    }

    function formatCell(row, colIndex, rowIndex){
      // rowIndex is 0-based for slice(1), so real index = rowIndex + 1
      const header = table2Data.value[0];
      const materialIdx = findColumnIndex(header,'物料信息');
      const contractIdx = findColumnIndex(header,'合同编号');

      if(colIndex === materialIdx){
        const realRowIndex = rowIndex + 1;
        const ids = entriesByRow[realRowIndex] || [];
        // 按 entries 的顺序渲染，matched -> blue, unmatched -> red
        return ids.map(id=>{
          const e = entries[id];
          if(!e) return '';
          if(e.used) return `<span title="已匹配到 ${e.contract}">${e.level} ${e.qty}</span>`;
          else return `<span style="color:red" title="未匹配">${e.level} ${e.qty}</span>`;
        }).join(', ');
      }

      // 其他列直接显示（如果是合同列也直接显示）
      return row[colIndex];
    }

    // 通用复制函数
    function copyText(text, msg="已复制到剪贴板！"){
      const textarea=document.createElement('textarea');
      textarea.value=text;
      textarea.style.position='fixed';
      textarea.style.top=0; textarea.style.left=0;
      textarea.style.width='1px'; textarea.style.height='1px';
      textarea.style.opacity=0;
      document.body.appendChild(textarea);
      textarea.focus(); textarea.select();
      try{
        const successful=document.execCommand('copy');
        if(successful) alert(msg);
        else alert('复制失败，请手动复制！');
      } catch(err){
        alert('复制失败，请手动复制！');
      }
      document.body.removeChild(textarea);
    }

    // 复制整表
    function copyResult(){
      if(!result.value.length) return;
      const text=result.value.map(row=>row.join("\t")).join("\n");
      copyText(text, "已复制结果到剪贴板！");
    }

    // 复制单元格
    function copyCell(cell){ copyText(cell, "已复制: "+cell); }

    // 复制整列
    function copyColumn(colIndex){
      if(!result.value.length) return;
      const text=result.value.map(row=>row[colIndex]).join("\n");
      copyText(text, "已复制整列到剪贴板！");
    }

    // 防抖 watch
    let debounceTimer = null;
    watch([table1Text, table2Text], ()=>{
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(updateMatch, 500);
    });

    return { table1Text, table2Text, result, table2Data, updateMatch, copyResult, copyCell, copyColumn,
             sumTable1Qty, sumMatchedQty, sumTable2Qty, sumTable2Weight,
             contractStats, levelStats, highlightedRows, highlightTable1, formatCell, table1Container };
  }
}).mount('#app');
</script>
</body>
</html>
